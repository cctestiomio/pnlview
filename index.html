<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Polymarket PnL Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; }
:root {
  --bg:#f8f9fb; --bg-card:#ffffff; --bg-input:#f3f4f6; --bg-hover:#f9fafb;
  --border:#e5e7eb; --border2:#d1d5db;
  --text:#111827; --text2:#374151; --text3:#6b7280; --text4:#9ca3af;
  --accent:#2563eb; --accent-bg:#eff6ff;
  --green:#059669; --green-bg:#ecfdf5; --green-t:#065f46;
  --red:#dc2626; --red-bg:#fef2f2; --red-t:#991b1b;
  --amber:#d97706; --amber-bg:#fffbeb;
  --purple:#7c3aed; --purple-bg:#f5f3ff;
  --sh:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.04);
  --sh2:0 4px 6px -1px rgba(0,0,0,.07),0 2px 4px -1px rgba(0,0,0,.04);
  --r:8px; --rsm:5px;
}
[data-theme="dark"] {
  --bg:#0d1117; --bg-card:#161b22; --bg-input:#21262d; --bg-hover:#1c2128;
  --border:#30363d; --border2:#3d444d;
  --text:#e6edf3; --text2:#c9d1d9; --text3:#8b949e; --text4:#484f58;
  --accent:#58a6ff; --accent-bg:#121d2f;
  --green:#3fb950; --green-bg:#0f2518; --green-t:#3fb950;
  --red:#f85149; --red-bg:#2d1010; --red-t:#f85149;
  --amber:#d29922; --amber-bg:#271d00;
  --purple:#a78bfa; --purple-bg:#1e1040;
  --sh:0 1px 3px rgba(0,0,0,.4); --sh2:0 4px 6px rgba(0,0,0,.5);
}
body { font-family:'Inter',-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; -webkit-font-smoothing:antialiased; transition:background .2s,color .2s; }
.wrap { max-width:1300px; margin:0 auto; padding:28px 20px 64px; }

/* NAV */
nav { display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; }
.nav-title { font-size:1.15rem; font-weight:700; letter-spacing:-.02em; }
.nav-sub { font-size:.7rem; font-weight:500; color:var(--text4); letter-spacing:.06em; text-transform:uppercase; margin-top:2px; }
.nav-r { display:flex; align-items:center; gap:8px; }
.pill { display:inline-flex; align-items:center; gap:6px; font-size:.7rem; font-weight:600; padding:5px 11px; border-radius:99px; border:1px solid var(--border); color:var(--text3); background:var(--bg-card); white-space:nowrap; }
.pill .dot { width:6px; height:6px; border-radius:50%; background:var(--text4); flex-shrink:0; }
.pill.on { color:var(--green); border-color:var(--green); background:var(--green-bg); }
.pill.on .dot { background:var(--green); animation:blink 2s infinite; }
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.tbtn { width:32px; height:32px; border-radius:var(--rsm); border:1px solid var(--border); background:var(--bg-card); color:var(--text3); cursor:pointer; font-size:.95rem; display:flex; align-items:center; justify-content:center; transition:all .15s; }
.tbtn:hover { border-color:var(--accent); color:var(--accent); }

/* DROP */
.drop { border:1.5px dashed var(--border2); border-radius:var(--r); background:var(--bg-card); padding:32px 24px; text-align:center; cursor:pointer; transition:all .15s; margin-bottom:20px; position:relative; }
.drop:hover,.drop.over { border-color:var(--accent); background:var(--accent-bg); }
.drop input { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
.drop-icon { font-size:1.5rem; margin-bottom:8px; }
.drop-title { font-size:.92rem; font-weight:600; color:var(--text); margin-bottom:3px; }
.drop-sub { font-size:.75rem; color:var(--text3); }
.drop-ok { margin-top:8px; font-size:.75rem; font-weight:600; color:var(--green); display:none; }

/* MAIN */
.main { display:none; }
.main.on { display:block; }

/* CARDS */
.cards { display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin-bottom:16px; }
@media(max-width:880px){.cards{grid-template-columns:repeat(3,1fr);}}
@media(max-width:520px){.cards{grid-template-columns:repeat(2,1fr);}}
.card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--r); padding:14px 16px; box-shadow:var(--sh); }
.card-lbl { font-size:.62rem; font-weight:600; letter-spacing:.08em; text-transform:uppercase; color:var(--text4); margin-bottom:8px; }
.card-val { font-size:1.55rem; font-weight:700; letter-spacing:-.025em; line-height:1; }
.card-val.g { color:var(--green); }
.card-val.r { color:var(--red); }
.card-val.b { color:var(--accent); font-size:1rem; letter-spacing:-.01em; }
.card-val.p { color:var(--purple); font-size:1rem; letter-spacing:-.01em; }
.card-sub { font-size:.7rem; color:var(--text4); margin-top:5px; }

/* FILTERS */
.filters { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--r); padding:14px 16px; margin-bottom:12px; box-shadow:var(--sh); }
.filters-hd { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
.filters-ttl { font-size:.82rem; font-weight:600; }
.rbtn { font-size:.7rem; font-weight:500; color:var(--text3); background:none; border:1px solid var(--border); border-radius:var(--rsm); padding:3px 9px; cursor:pointer; transition:all .15s; font-family:inherit; }
.rbtn:hover { color:var(--accent); border-color:var(--accent); }
.frow { display:flex; flex-wrap:wrap; gap:8px; }
.fg { display:flex; flex-direction:column; gap:4px; min-width:130px; flex:1; }
.fg label { font-size:.62rem; font-weight:600; letter-spacing:.07em; text-transform:uppercase; color:var(--text3); }
.fg select { font-family:'Inter',sans-serif; font-size:.78rem; font-weight:500; color:var(--text); background:var(--bg-input); border:1px solid var(--border); border-radius:var(--rsm); padding:6px 26px 6px 9px; outline:none; cursor:pointer; transition:border-color .15s; appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2.5'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 8px center; }
.fg select:focus { border-color:var(--accent); }

/* TIME BUCKET FILTER — full-width row below main filters */
.bucket-row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px; padding-top:10px; border-top:1px solid var(--border); }
.bucket-lbl { font-size:.62rem; font-weight:600; letter-spacing:.07em; text-transform:uppercase; color:var(--text3); white-space:nowrap; }
.bucket-btns { display:flex; flex-wrap:wrap; gap:5px; }
.bbtn { font-size:.7rem; font-weight:600; padding:4px 11px; border-radius:99px; border:1px solid var(--border); background:var(--bg-input); color:var(--text3); cursor:pointer; transition:all .15s; font-family:inherit; white-space:nowrap; }
.bbtn:hover { border-color:var(--purple); color:var(--purple); }
.bbtn.active { background:var(--purple-bg); border-color:var(--purple); color:var(--purple); }

/* TIME HEATMAP SECTION */
.heatmap-wrap { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--r); padding:14px 16px; margin-bottom:12px; box-shadow:var(--sh); }
.heatmap-ttl { font-size:.82rem; font-weight:600; margin-bottom:12px; }
.heatmap-grid { display:flex; flex-wrap:wrap; gap:6px; }
.hm-cell { display:flex; flex-direction:column; align-items:center; justify-content:center; border-radius:var(--rsm); border:1px solid var(--border); padding:7px 10px; min-width:80px; cursor:pointer; transition:all .15s; position:relative; }
.hm-cell:hover { border-color:var(--purple); transform:translateY(-1px); box-shadow:var(--sh2); }
.hm-cell.active { border-color:var(--purple); background:var(--purple-bg); }
.hm-range { font-size:.6rem; font-weight:600; letter-spacing:.05em; text-transform:uppercase; color:var(--text4); margin-bottom:5px; }
.hm-wr { font-size:1.1rem; font-weight:700; line-height:1; }
.hm-wr.g { color:var(--green); } .hm-wr.a { color:var(--amber); } .hm-wr.r { color:var(--red); } .hm-wr.z { color:var(--text4); }
.hm-trades { font-size:.65rem; color:var(--text4); margin-top:3px; }
.hm-pnl { font-size:.65rem; font-weight:600; margin-top:2px; }
.hm-pnl.g { color:var(--green); } .hm-pnl.r { color:var(--red); } .hm-pnl.z { color:var(--text4); }

/* AGG */
.agg { background:var(--accent-bg); border:1px solid color-mix(in srgb,var(--accent) 22%,transparent); border-radius:var(--r); padding:11px 16px; margin-bottom:12px; display:none; align-items:center; flex-wrap:wrap; gap:4px 20px; }
.agg.on { display:flex; }
.agg-lbl { font-size:.6rem; font-weight:600; letter-spacing:.07em; text-transform:uppercase; color:var(--accent); opacity:.65; }
.agg-v { font-size:.95rem; font-weight:700; color:var(--accent); }
.agg-v.g { color:var(--green); } .agg-v.r { color:var(--red); }
.agg-i { display:flex; flex-direction:column; }
.agg-div { width:1px; height:30px; background:color-mix(in srgb,var(--accent) 18%,transparent); align-self:center; }
.agg-ttl { font-size:.75rem; font-weight:600; color:var(--accent); margin-right:6px; align-self:center; }

/* TABLE */
.tbl-wrap { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--r); box-shadow:var(--sh); overflow:hidden; }
.tbl-hd { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border); }
.tbl-ttl { font-size:.85rem; font-weight:600; }
.row-badge { font-size:.68rem; font-weight:600; color:var(--text3); background:var(--bg-input); border:1px solid var(--border); border-radius:99px; padding:2px 9px; }
.tscroll { overflow-x:auto; }
table { width:100%; border-collapse:collapse; }
thead th { font-size:.62rem; font-weight:600; letter-spacing:.06em; text-transform:uppercase; color:var(--text4); text-align:left; padding:8px 13px; background:var(--bg-input); border-bottom:1px solid var(--border); white-space:nowrap; cursor:pointer; user-select:none; transition:color .12s; }
thead th:hover { color:var(--accent); }
thead th.sa::after { content:' \2191'; color:var(--accent); }
thead th.sd::after { content:' \2193'; color:var(--accent); }
thead th:not(.sa):not(.sd)::after { content:' \2195'; opacity:.2; }
tbody tr { border-bottom:1px solid var(--border); transition:background .1s; }
tbody tr:last-child { border-bottom:none; }
tbody tr:hover { background:var(--bg-hover); }
td { padding:9px 13px; font-size:.8rem; color:var(--text2); white-space:nowrap; }
td.n { font-size:.77rem; font-weight:500; }
.tag { display:inline-flex; align-items:center; font-size:.67rem; font-weight:600; padding:2px 7px; border-radius:4px; }
.tm { background:var(--accent-bg); color:var(--accent); }
.tw { background:var(--green-bg); color:var(--green-t); }
.tl { background:var(--red-bg); color:var(--red-t); }
.tu { background:var(--bg-input); color:var(--text3); border:1px solid var(--border); }
.tp { background:var(--purple-bg); color:var(--purple); }
.t0 { color:var(--text4); font-size:.75rem; font-weight:500; }
.wb { display:flex; align-items:center; gap:7px; }
.wt { flex:1; min-width:50px; height:4px; border-radius:99px; background:var(--border); overflow:hidden; }
.wf { height:100%; border-radius:99px; }
.wf.g{background:var(--green);} .wf.a{background:var(--amber);} .wf.r{background:var(--red);}
.wn { font-size:.72rem; font-weight:600; min-width:38px; text-align:right; }
.wn.g{color:var(--green);} .wn.a{color:var(--amber);} .wn.r{color:var(--red);}
.pnl { font-size:.78rem; font-weight:600; }
.pnl.g{color:var(--green);} .pnl.r{color:var(--red);} .pnl.z{color:var(--text4);}
.empty { padding:36px 20px; text-align:center; color:var(--text4); font-size:.8rem; }
</style>
</head>
<body>
<div class="wrap">

<nav>
  <div>
    <div class="nav-title">PnL Dashboard</div>
    <div class="nav-sub">Polymarket Up/Down Tracker</div>
  </div>
  <div class="nav-r">
    <div class="pill" id="pill"><span class="dot"></span><span id="pill-txt">No data loaded</span></div>
    <button class="tbtn" id="tbtn">&#9788;</button>
  </div>
</nav>

<div class="drop" id="drop">
  <input type="file" accept=".csv" id="fi" />
  <div class="drop-icon">&#128194;</div>
  <div class="drop-title">Drop your pnl_tracker.csv here</div>
  <div class="drop-sub">or click to browse &mdash; nothing is uploaded, all local</div>
  <div class="drop-ok" id="dok"></div>
</div>

<div class="main" id="main">
  <div class="cards" id="cards"></div>

  <div class="filters">
    <div class="filters-hd">
      <span class="filters-ttl">Filter Combinations</span>
      <button class="rbtn" id="rbtn">Reset all</button>
    </div>
    <div class="frow" id="frow"></div>
    <!-- Time bucket strip -->
    <div class="bucket-row">
      <span class="bucket-lbl">Trigger Time</span>
      <div class="bucket-btns" id="bbtnrow"></div>
    </div>
  </div>

  <!-- Heatmap: winrate by time bucket -->
  <div class="heatmap-wrap" id="hmwrap">
    <div class="heatmap-ttl">Winrate by Time Remaining at Trigger</div>
    <div class="heatmap-grid" id="hmgrid"></div>
  </div>

  <div class="agg" id="agg"></div>

  <div class="tbl-wrap">
    <div class="tbl-hd">
      <span class="tbl-ttl">Results</span>
      <span class="row-badge" id="rb">0 rows</span>
    </div>
    <div class="tscroll">
      <table><thead id="th"></thead><tbody id="tb"></tbody></table>
    </div>
    <div class="empty" id="em" style="display:none">No rows match your filters.</div>
  </div>
</div>

</div>
<script>
// ─── State ───────────────────────────────────────────────────────────────────
var R=[], sk=null, sd=1, activeBucket=null;

// ─── Columns ─────────────────────────────────────────────────────────────────
var COLS=[
  {k:'market',h:'Market'},
  {k:'trigger_price',h:'Trigger'},
  {k:'order_price',h:'Limit'},
  {k:'window_min',h:'Win. Min'},
  {k:'window_max',h:'Win. Max'},
  {k:'secs_at_trigger',h:'Trig. At'},
  {k:'wins',h:'Wins'},
  {k:'losses',h:'Losses'},
  {k:'unfilled',h:'Unfilled'},
  {k:'winrate',h:'Winrate'},
  {k:'pnl',h:'P / L'}
];

// Dropdown filter keys (NOT including secs_at_trigger — that uses bucket UI)
var FK=['market','trigger_price','order_price','window_min','window_max'];

// ─── Time buckets ─────────────────────────────────────────────────────────────
// Buckets are defined as [label, minSecs, maxSecs] (inclusive min, exclusive max).
// Auto-generated from the data range; these are the starting presets.
var PRESET_BUCKETS=[
  ['0–60s',    0,   60],
  ['60–120s',  60,  120],
  ['120–180s', 120, 180],
  ['180–240s', 180, 240],
  ['240–300s', 240, 300],
  ['300–450s', 300, 450],
  ['450–600s', 450, 600],
  ['600–900s', 600, 900],
];

function getBucketLabel(secs) {
  for (var i=0; i<PRESET_BUCKETS.length; i++) {
    var b=PRESET_BUCKETS[i];
    if (secs >= b[1] && secs < b[2]) return b[0];
  }
  return secs+'s';
}

function inBucket(secs, bucket) {
  if (!bucket) return true;
  return secs >= bucket[1] && secs < bucket[2];
}

// ─── Theme ───────────────────────────────────────────────────────────────────
var root=document.documentElement, tbtn=document.getElementById('tbtn'), dark=false;
function theme(d){dark=d;root.setAttribute('data-theme',d?'dark':'light');tbtn.innerHTML=d?'&#9790;':'&#9788;';try{localStorage.setItem('t',d?'1':'0');}catch(e){}}
tbtn.onclick=function(){theme(!dark);};
try{if(localStorage.getItem('t')==='1')theme(true);}catch(e){}

// ─── CSV parser ──────────────────────────────────────────────────────────────
function csv(t){
  var L=t.trim().split(/\r?\n/);
  if(L.length<2)return[];
  var H=L[0].split(',').map(function(h){return h.trim().toLowerCase().replace(/\s+/g,'_');});
  return L.slice(1).map(function(l){
    var v=[],c='',q=false;
    for(var i=0;i<l.length;i++){var ch=l[i];if(ch==='"'){q=!q;continue;}if(ch===','&&!q){v.push(c.trim());c='';continue;}c+=ch;}
    v.push(c.trim());
    var r={};H.forEach(function(h,i){r[h]=v[i]||'';});
    return r;
  }).filter(function(r){return r.market;});
}

function cook(r){
  var w=parseInt(r.wins)||0, l=parseInt(r.losses)||0, t=w+l;
  var secs=parseInt(r.secs_at_trigger)||0;
  return {
    market:          r.market||'',
    trigger_price:   parseFloat(r.trigger_price)||0,
    order_price:     parseFloat(r.order_price)||0,
    window_min:      parseInt(r.window_min)||0,
    window_max:      parseInt(r.window_max)||0,
    secs_at_trigger: secs,
    wins:w, losses:l, unfilled:parseInt(r.unfilled)||0,
    pnl:parseFloat(r.pnl)||0,
    winrate:t>0?(w/t)*100:0
  };
}

// ─── File loading ─────────────────────────────────────────────────────────────
var drop=document.getElementById('drop'), fi=document.getElementById('fi');
drop.addEventListener('dragover',function(e){e.preventDefault();drop.classList.add('over');});
drop.addEventListener('dragleave',function(){drop.classList.remove('over');});
drop.addEventListener('drop',function(e){e.preventDefault();drop.classList.remove('over');if(e.dataTransfer.files[0])load(e.dataTransfer.files[0]);});
fi.addEventListener('change',function(e){if(e.target.files[0])load(e.target.files[0]);});

function load(f){
  var rd=new FileReader();
  rd.onload=function(e){
    var raw=csv(e.target.result);
    R=raw.map(cook);
    if(!R.length){alert('No valid rows found.');return;}
    var dok=document.getElementById('dok');
    dok.textContent='Loaded: '+f.name+' ('+R.length+' configs)';
    dok.style.display='block';
    var p=document.getElementById('pill');
    p.className='pill on';
    document.getElementById('pill-txt').textContent=R.length+' configs loaded';
    document.getElementById('main').className='main on';
    activeBucket=null;
    buildF();
    buildBucketBtns();
    go();
  };
  rd.readAsText(f);
}

// ─── Dropdown filters ─────────────────────────────────────────────────────────
function uniq(k){
  var s={},o=[];
  R.forEach(function(r){if(!s[r[k]]){s[r[k]]=true;o.push(r[k]);}});
  o.sort(function(a,b){return typeof a==='number'?a-b:String(a).localeCompare(String(b));});
  return o;
}

function buildF(){
  var row=document.getElementById('frow');
  row.innerHTML='';
  FK.forEach(function(k){
    var col=COLS.filter(function(c){return c.k===k;})[0];
    var vals=uniq(k);
    var fg=document.createElement('div'); fg.className='fg';
    var lbl=document.createElement('label'); lbl.textContent=col.h;
    var sel=document.createElement('select'); sel.id='f-'+k;
    sel.innerHTML='<option value="">All</option>';
    vals.forEach(function(v){
      var o=document.createElement('option'); o.value=v;
      if(k==='trigger_price'||k==='order_price') o.textContent='$'+parseFloat(v).toFixed(2);
      else if(k==='window_min'||k==='window_max') o.textContent=v+'s';
      else o.textContent=v;
      sel.appendChild(o);
    });
    sel.addEventListener('change',go);
    fg.appendChild(lbl); fg.appendChild(sel); row.appendChild(fg);
  });
}

function gf(){
  var f={};
  FK.forEach(function(k){var el=document.getElementById('f-'+k);if(el&&el.value!=='')f[k]=el.value;});
  return f;
}

document.getElementById('rbtn').addEventListener('click',function(){
  FK.forEach(function(k){var el=document.getElementById('f-'+k);if(el)el.value='';});
  activeBucket=null;
  renderBucketBtns();
  go();
});

// ─── Bucket buttons ──────────────────────────────────────────────────────────
function buildBucketBtns(){
  // Determine which buckets are actually present in the data
  var present=new Set();
  R.forEach(function(r){ present.add(getBucketLabel(r.secs_at_trigger)); });
  renderBucketBtns(present);
}

function renderBucketBtns(present){
  var row=document.getElementById('bbtnrow');
  row.innerHTML='';

  // "All" button
  var all=document.createElement('button');
  all.className='bbtn'+(activeBucket===null?' active':'');
  all.textContent='All times';
  all.addEventListener('click',function(){ activeBucket=null; renderBucketBtns(); go(); });
  row.appendChild(all);

  // One button per preset bucket that has any data
  PRESET_BUCKETS.forEach(function(b){
    var has=R.some(function(r){ return r.secs_at_trigger>=b[1] && r.secs_at_trigger<b[2]; });
    if(!has) return;
    var btn=document.createElement('button');
    var isActive=activeBucket&&activeBucket[0]===b[0];
    btn.className='bbtn'+(isActive?' active':'');
    btn.textContent=b[0];
    btn.addEventListener('click',function(){
      activeBucket=isActive?null:b;
      renderBucketBtns();
      go();
    });
    row.appendChild(btn);
  });
}

// ─── Heatmap ──────────────────────────────────────────────────────────────────
function buildHeatmap(filtered){
  var grid=document.getElementById('hmgrid');
  grid.innerHTML='';

  // Group by bucket
  var bucketData={};
  PRESET_BUCKETS.forEach(function(b){
    bucketData[b[0]]={label:b[0],bucket:b,wins:0,losses:0,unfilled:0,pnl:0,count:0};
  });

  // Use ALL data (not filtered) for the heatmap so you always see the full picture
  R.forEach(function(r){
    PRESET_BUCKETS.forEach(function(b){
      if(r.secs_at_trigger>=b[1]&&r.secs_at_trigger<b[2]){
        var bd=bucketData[b[0]];
        bd.wins+=r.wins; bd.losses+=r.losses; bd.unfilled+=r.unfilled; bd.pnl+=r.pnl; bd.count++;
      }
    });
  });

  var anyData=false;
  PRESET_BUCKETS.forEach(function(b){
    var bd=bucketData[b[0]];
    if(!bd.count) return;
    anyData=true;
    var total=bd.wins+bd.losses;
    var wr=total>0?(bd.wins/total*100):0;
    var wc=wr>=60?'g':wr>=45?'a':'r';
    if(total===0) wc='z';
    var ps=(bd.pnl>=0?'+':'')+'$'+Math.abs(bd.pnl).toFixed(2);
    var pc=bd.pnl>0?'g':bd.pnl<0?'r':'z';
    var isActive=activeBucket&&activeBucket[0]===b[0];

    var cell=document.createElement('div');
    cell.className='hm-cell'+(isActive?' active':'');
    cell.innerHTML=
      '<div class="hm-range">'+b[0]+'</div>'+
      '<div class="hm-wr '+wc+'">'+(total===0?'—':wr.toFixed(1)+'%')+'</div>'+
      '<div class="hm-trades">'+bd.wins+'W / '+bd.losses+'L'+(bd.unfilled?' / '+bd.unfilled+'U':'')+'</div>'+
      '<div class="hm-pnl '+pc+'">'+ps+'</div>';
    cell.addEventListener('click',function(){
      activeBucket=(isActive?null:b);
      renderBucketBtns();
      buildHeatmap(filtered);
      go();
    });
    grid.appendChild(cell);
  });

  document.getElementById('hmwrap').style.display=anyData?'':'none';
}

// ─── Summary cards ─────────────────────────────────────────────────────────────
function s(a,k){return a.reduce(function(x,r){return x+r[k];},0);}

function cards(a){
  var w=s(a,'wins'),l=s(a,'losses'),u=s(a,'unfilled'),p=s(a,'pnl'),t=w+l;
  var wr=t>0?(w/t*100):0;
  var best=a.slice().sort(function(a,b){return b.pnl-a.pnl;})[0];
  var bucketLabel=activeBucket?activeBucket[0]:'All times';
  var ps=p>=0?'+':'', pc=p>0?'g':p<0?'r':'', wc=wr>=60?'g':wr>=45?'b':'r';
  document.getElementById('cards').innerHTML=
    mk('Total Trades',''+t,u+' unfilled','')+
    mk('Win / Loss',w+'<span style="color:var(--text4);font-weight:400;font-size:1rem"> / '+l+'</span>','across '+a.length+' config'+(a.length!==1?'s':''),'')+
    mk('Winrate',wr.toFixed(1)+'%',t+' resolved',wc)+
    mk('Total P/L',ps+'$'+Math.abs(p).toFixed(2),'all configs',pc)+
    mk('Active Filter','<span style="font-size:.85rem">'+bucketLabel+'</span>',best?'Best P/L: '+(best.pnl>=0?'+':'')+'$'+Math.abs(best.pnl).toFixed(2):'No data','p');
}

function mk(lbl,val,sub,cls){return '<div class="card"><div class="card-lbl">'+lbl+'</div><div class="card-val '+cls+'">'+val+'</div><div class="card-sub">'+sub+'</div></div>';}

// ─── Agg bar ──────────────────────────────────────────────────────────────────
function agg(a){
  var ag=document.getElementById('agg');
  var act=FK.some(function(k){var el=document.getElementById('f-'+k);return el&&el.value!=='';});
  var bucketActive=activeBucket!==null;
  if((!act&&!bucketActive)||!a.length){ag.className='agg';return;}
  var w=s(a,'wins'),l=s(a,'losses'),u=s(a,'unfilled'),p=s(a,'pnl'),t=w+l,wr=t>0?(w/t*100):0;
  var ps=(p>=0?'+':'')+'$'+Math.abs(p).toFixed(2),wc=wr>=60?'g':wr<45?'r':'',pc=p>0?'g':p<0?'r':'';
  ag.innerHTML='<span class="agg-ttl">'+a.length+' config'+(a.length!==1?'s':'')+' selected</span>'+
    '<div class="agg-div"></div>'+
    '<div class="agg-i"><div class="agg-lbl">Trades</div><div class="agg-v">'+t+'</div></div>'+
    '<div class="agg-i"><div class="agg-lbl">Wins</div><div class="agg-v g">'+w+'</div></div>'+
    '<div class="agg-i"><div class="agg-lbl">Losses</div><div class="agg-v r">'+l+'</div></div>'+
    '<div class="agg-i"><div class="agg-lbl">Unfilled</div><div class="agg-v">'+u+'</div></div>'+
    '<div class="agg-div"></div>'+
    '<div class="agg-i"><div class="agg-lbl">Winrate</div><div class="agg-v '+wc+'">'+wr.toFixed(1)+'%</div></div>'+
    '<div class="agg-i"><div class="agg-lbl">P / L</div><div class="agg-v '+pc+'">'+ps+'</div></div>';
  ag.className='agg on';
}

// ─── Table ────────────────────────────────────────────────────────────────────
function head(){
  var h='<tr>';
  COLS.forEach(function(c){
    var cl=sk===c.k?(sd===1?'sa':'sd'):'';
    h+='<th class="'+cl+'" data-key="'+c.k+'">'+c.h+'</th>';
  });
  document.getElementById('th').innerHTML=h+'</tr>';
  document.querySelectorAll('#th th').forEach(function(th){
    th.addEventListener('click',function(){
      if(sk===th.dataset.key) sd=-sd; else{sk=th.dataset.key;sd=1;}
      go();
    });
  });
}

function secsLabel(s){
  if(s===0) return '<span class="tag tu">0s</span>';
  return '<span class="tag tp">'+s+'s</span>';
}

function tbl(a){
  head();
  var tb=document.getElementById('tb'), em=document.getElementById('em');
  document.getElementById('rb').textContent=a.length+' row'+(a.length!==1?'s':'');
  if(!a.length){tb.innerHTML='';em.style.display='block';return;}
  em.style.display='none';
  var sorted=a.slice();
  if(sk) sorted.sort(function(a,b){var av=a[sk],bv=b[sk];return(typeof av==='number'?av-bv:String(av).localeCompare(String(bv)))*sd;});
  tb.innerHTML=sorted.map(function(r){
    var wc=r.winrate>=60?'g':r.winrate>=45?'a':'r';
    var ps=(r.pnl>=0?'+':'')+'$'+Math.abs(r.pnl).toFixed(2);
    var pc=r.pnl>0?'g':r.pnl<0?'r':'z';
    return '<tr>'+
      '<td><span class="tag tm">'+r.market+'</span></td>'+
      '<td class="n">$'+r.trigger_price.toFixed(2)+'</td>'+
      '<td class="n">$'+r.order_price.toFixed(2)+'</td>'+
      '<td class="n">'+r.window_min+'s</td>'+
      '<td class="n">'+r.window_max+'s</td>'+
      '<td>'+secsLabel(r.secs_at_trigger)+'</td>'+
      '<td>'+(r.wins>0?'<span class="tag tw">'+r.wins+'W</span>':'<span class="t0">0W</span>')+'</td>'+
      '<td>'+(r.losses>0?'<span class="tag tl">'+r.losses+'L</span>':'<span class="t0">0L</span>')+'</td>'+
      '<td>'+(r.unfilled>0?'<span class="tag tu">'+r.unfilled+'U</span>':'<span class="t0">0U</span>')+'</td>'+
      '<td><div class="wb"><div class="wt"><div class="wf '+wc+'" style="width:'+r.winrate.toFixed(1)+'%"></div></div><span class="wn '+wc+'">'+r.winrate.toFixed(1)+'%</span></div></td>'+
      '<td><span class="pnl '+pc+'">'+ps+'</span></td>'+
      '</tr>';
  }).join('');
}

// ─── Main render ──────────────────────────────────────────────────────────────
function go(){
  var f=gf();
  var filtered=R.filter(function(r){
    // Dropdown filters
    var dropOk=Object.keys(f).every(function(k){
      var v=f[k];if(!v)return true;
      var rv=r[k];
      return typeof rv==='number'?rv===Number(v):String(rv)===String(v);
    });
    // Bucket filter
    var bucketOk=!activeBucket||(r.secs_at_trigger>=activeBucket[1]&&r.secs_at_trigger<activeBucket[2]);
    return dropOk && bucketOk;
  });
  cards(filtered);
  buildHeatmap(filtered);
  agg(filtered);
  tbl(filtered);
}
</script>
</body>
</html>